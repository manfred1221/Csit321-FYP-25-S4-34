<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit User</title>
    <link rel="stylesheet" href="/frontend/css/styles.css">
    <script src="/frontend/js/config.js"></script>
    <style>
        #tempWorkerFields { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
        #tempWorkerFields.show { display: block; }
        .upload-area { border: 2px dashed #cbd5e1; padding: 20px; cursor: pointer; text-align: center; border-radius: 6px; transition: all 0.3s; }
        .upload-area:hover { border-color: #3b82f6; background: #f0f9ff; }
        .message { margin-bottom: 15px; padding: 10px; border-radius: 6px; display: none; }
        .message.error { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }
        .message.success { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .status-box { padding: 15px; border-radius: 6px; text-align: center; margin-bottom: 20px; font-weight: bold; }
        .status-registered { background: #dcfce7; color: #166534; }
        .status-missing { background: #fef3c7; color: #92400e; }
        .current-photo img { max-width: 150px; border-radius: 6px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üè¢ Condo Access</h2>
                <div class="user-info"><strong id="adminNameSidebar">Loading...</strong></div>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="/admin/profile" class="nav-link">üë§ My Profile</a></li>
                    <li class="nav-item"><a href="/admin/users" class="nav-link active">üë• User Management</a></li>
                    <li class="nav-item"><a href="/admin/staff-schedules" class="nav-link">üìÖ Staff Schedules</a></li>
                    <li class="nav-item"><a href="/admin/temp-workers" class="nav-link">üîß Temp Workers</a></li>
                    <li class="nav-item"><a href="/admin/logs" class="nav-link">üìã Access Logs</a></li>
                    <li class="nav-item"><a href="#" onclick="logout(); return false;" class="nav-link">üö™ Logout</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <a href="/admin/users" class="btn-text">‚Üê Back to Users</a>
                <h1>Edit User: {{ user.username }}</h1>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                <div class="card">
                    <div class="card-header"><h2>General Information</h2></div>
                    <div class="card-body">
                        <div class="message error" id="error"></div>
                        <div class="message success" id="success"></div>

                        <form id="userForm">
                            <div class="form-group"><label>Full Name</label><input type="text" id="full_name" value="{{ user.full_name or '' }}" class="form-control"></div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group"><label>Email</label><input type="email" id="email" value="{{ user.email or '' }}" class="form-control"></div>
                                <div class="form-group"><label>Phone</label><input type="text" id="phone" value="{{ user.phone or '' }}" class="form-control"></div>
                            </div>

                            <div class="form-group"><label>New Password</label><input type="password" id="password" class="form-control" placeholder="Leave blank to keep current"></div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label>Role</label>
                                    <select id="role" class="form-control" onchange="toggleTempWorkerFields()">
                                        <option value="Admin" {% if user.role|lower == 'admin' %}selected{% endif %}>Admin</option>
                                        <option value="Resident" {% if user.role|lower == 'resident' %}selected{% endif %}>Resident</option>
                                        <option value="Security" {% if user.role|lower == 'security' or user.role|lower == 'security_officer' %}selected{% endif %}>Security</option>
                                        <option value="Internal Staff" {% if user.role|lower == 'internal staff' or user.role|lower == 'internal_staff' %}selected{% endif %}>Internal Staff</option>
                                        <option value="TempWorker" {% if user.role|lower == 'tempworker' or user.role|lower == 'temp_staff' %}selected{% endif %}>Temp Worker</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Status</label>
                                    <select id="status" class="form-control">
                                        <option value="active" {% if user.status == 'active' %}selected{% endif %}>Active</option>
                                        <option value="inactive" {% if user.status == 'inactive' %}selected{% endif %}>Inactive</option>
                                    </select>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label>Access Level</label>
                                    <select id="access_level" class="form-control">
                                        <option value="standard" {% if user.access_level=='standard' %}selected{% endif %}>Standard</option>
                                        <option value="restricted" {% if user.access_level=='restricted' %}selected{% endif %}>Restricted</option>
                                        <option value="elevated" {% if user.access_level=='elevated' %}selected{% endif %}>Elevated</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Unit Number</label>
                                    <input type="text" id="unit_number" value="{{ user.unit_number or '' }}" class="form-control">
                                </div>
                            </div>

                            <div id="tempWorkerFields">
                                <h3>Worker Contract Details</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                                    <div class="form-group"><label>Work Start Date</label><input type="date" id="work_start_date" value="{{ user.work_start_date.strftime('%Y-%m-%d') if user.work_start_date else '' }}" class="form-control"></div>
                                    <div class="form-group"><label>Work End Date</label><input type="date" id="work_end_date" value="{{ user.work_end_date.strftime('%Y-%m-%d') if user.work_end_date else '' }}" class="form-control"></div>
                                </div>
                                <div class="form-group"><label>Work Schedule</label><input type="text" id="work_schedule" value="{{ user.work_schedule or '' }}" class="form-control"></div>
                                <div class="form-group"><label>Work Details</label><textarea id="work_details" class="form-control" rows="3">{{ user.work_details or '' }}</textarea></div>
                            </div>

                            <button type="submit" class="btn btn-primary" style="width:100%; margin-top: 20px;">Save Changes</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h2>Access Status</h2></div>
                    <div class="card-body">
                        <div class="status-box {{ 'status-registered' if user.face_encoding_path else 'status-missing' }}">
                            {{ '‚úì Face Registered' if user.face_encoding_path else '‚ö† Face Not Set' }}
                        </div>
                        <div style="margin-bottom: 30px; text-align: center;">
                            {% if user.photo_path %}
                            <div class="current-photo"><img src="/uploads/{{ user.photo_path.split('/')[-1] }}" alt="Current"></div>
                            {% endif %}
                            <label style="display:block; margin-bottom:10px; font-weight:600;">Update Photo</label>
                            <div class="message" id="photoAlert"></div>
                            <div class="upload-area" id="photoArea" onclick="document.getElementById('photoInput').click()">
                                <p>Click to Upload New Photo</p>
                            </div>
                            <input type="file" id="photoInput" style="display:none;" accept="image/*">
                            <button id="uploadPhotoBtn" class="btn btn-secondary" onclick="uploadPhoto()" disabled style="width:100%; margin-top:10px;">Upload Photo</button>
                        </div>
                        <div style="text-align: center; border-top: 1px solid #e2e8f0; padding-top: 20px;">
                            <label style="display:block; margin-bottom:10px; font-weight:600;">ID Document</label>
                            <div class="message" id="docAlert"></div>
                            {% if user.id_document_path %}
                            <p style="margin-bottom:10px; color: green;">‚úì Document on file</p>
                            {% endif %}
                            <div class="upload-area" id="docArea" onclick="document.getElementById('docInput').click()">
                                <p>Click to Upload Document</p>
                            </div>
                            <input type="file" id="docInput" style="display:none;" accept=".pdf,.jpg,.png,.jpeg">
                            <button id="uploadDocBtn" class="btn btn-secondary" onclick="uploadDoc()" disabled style="width:100%; margin-top:10px;">Upload Document</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const userId = "{{ user.id }}";

        document.addEventListener('DOMContentLoaded', async () => {
            const currentUser = await checkAuth(); 
            if (!currentUser || currentUser.role !== 'Admin') { window.location.href = '/login'; return; }
            document.getElementById('adminNameSidebar').textContent = currentUser.full_name || currentUser.username;
            toggleTempWorkerFields();
        });

        function toggleTempWorkerFields() {
            const role = document.getElementById('role').value;
            const tempFields = document.getElementById('tempWorkerFields');
            if (role === 'TempWorker') tempFields.classList.add('show');
            else tempFields.classList.remove('show');
        }

        document.getElementById('userForm').onsubmit = async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('error');
            const successDiv = document.getElementById('success');
            errorDiv.style.display = 'none'; successDiv.style.display = 'none';

            const data = {
                full_name: document.getElementById('full_name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value,
                status: document.getElementById('status').value, 
                access_level: document.getElementById('access_level').value,
                unit_number: document.getElementById('unit_number').value
            };

            if (data.role === 'TempWorker') {
                data.work_start_date = document.getElementById('work_start_date').value || null;
                data.work_end_date = document.getElementById('work_end_date').value || null;
                data.work_schedule = document.getElementById('work_schedule').value;
                data.work_details = document.getElementById('work_details').value;
            }

            try {
                const response = await fetch(`/admin/users/${userId}/edit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    successDiv.textContent = 'User updated successfully!';
                    successDiv.style.display = 'block';
                    window.scrollTo(0, 0);
                } else {
                    errorDiv.textContent = result.message || 'Update failed';
                    errorDiv.style.display = 'block';
                }
            } catch (err) {
                errorDiv.textContent = 'Network error'; errorDiv.style.display = 'block';
            }
        };

        const setupUpload = (inputId, areaId, btnId, alertId, endpoint) => {
            const input = document.getElementById(inputId);
            if(!input) return;
            input.onchange = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        document.getElementById(areaId).innerHTML = inputId === 'photoInput' 
                            ? `<img src="${ev.target.result}" style="max-height:150px;">` 
                            : `<p>${file.name}</p>`;
                        document.getElementById(btnId).disabled = false;
                        document.getElementById(btnId).className = 'btn btn-primary';
                    };
                    reader.readAsDataURL(file);
                }
            };
            document.getElementById(btnId).onclick = async () => {
                const btn = document.getElementById(btnId);
                const alertBox = document.getElementById(alertId);
                btn.disabled = true; btn.textContent = 'Uploading...';
                const formData = new FormData();
                formData.append(inputId === 'photoInput' ? 'photo' : 'document', input.files[0]);
                try {
                    const res = await fetch(endpoint, { method: 'POST', body: formData });
                    const data = await res.json();
                    if(data.success) {
                        alertBox.className = 'message success'; alertBox.textContent = data.message; alertBox.style.display = 'block';
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        alertBox.className = 'message error'; alertBox.textContent = data.message; alertBox.style.display = 'block';
                        btn.disabled = false; btn.textContent = 'Upload';
                    }
                } catch(e) {
                    alertBox.className = 'message error'; alertBox.textContent = 'Network error'; alertBox.style.display = 'block';
                    btn.disabled = false;
                }
            };
        };

        setupUpload('photoInput', 'photoArea', 'uploadPhotoBtn', 'photoAlert', `/admin/users/${userId}/upload-photo`);
        setupUpload('docInput', 'docArea', 'uploadDocBtn', 'docAlert', `/admin/users/${userId}/upload-id-doc`);
    </script>
</body>
</html>