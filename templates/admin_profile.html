<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Profile - Condo Access</title>
    <link rel="stylesheet" href="/frontend/css/styles.css">
    <script src="/frontend/js/config.js"></script>
    <style>
        /* Maintain specific profile card styling within the new layout */
        .container-profile {
            max-width: 800px;
            margin: 0 auto;
        }

        .avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #fff;
            overflow: hidden;
            flex-shrink: 0;
        }

        .avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-area {
            border: 3px dashed #cbd5e1;
            border-radius: 8px;
            padding: 40px 30px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8fafc;
            text-align: center;
        }

        .upload-area:hover {
            border-color: #3b82f6;
            background: #f0f7ff;
        }

        .upload-area.has-image {
            border-style: solid;
            border-color: #10b981;
            background: #ecfdf5;
        }

        .upload-area img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M120-120v-560h160v-160h400v320h160v400H520v-160h-80v160H120Zm80-80h80v-80h-80v80Zm0-160h80v-80h-80v80Zm0-160h80v-80h-80v80Zm160 160h80v-80h-80v80Zm0-160h80v-80h-80v80Zm0-160h80v-80h-80v80Zm160 320h80v-80h-80v80Zm0-160h80v-80h-80v80Zm0-160h80v-80h-80v80Zm160 480h80v-80h-80v80Zm0-160h80v-80h-80v80Z"/></svg> Condo Access</h2>
                <div class="user-info">
                    <strong id="adminNameSidebar">Loading...</strong>
                    <p id="adminEmailSidebar">admin@condo.com</p>
                </div>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="/admin/profile" class="nav-link active"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M234-276q51-39 114-61.5T480-360q69 0 132 22.5T726-276q35-41 54.5-93T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 59 19.5 111t54.5 93Zm246-164q-59 0-99.5-40.5T340-580q0-59 40.5-99.5T480-720q59 0 99.5 40.5T620-580q0 59-40.5 99.5T480-440Zm0 360q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q53 0 100-15.5t86-44.5q-39-29-86-44.5T480-280q-53 0-100 15.5T294-220q39 29 86 44.5T480-160Zm0-360q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm0-60Zm0 360Z"/></svg> My Profile</a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/users" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M0-240v-63q0-43 44-70t116-27q13 0 25 .5t23 2.5q-14 21-21 44t-7 48v65H0Zm240 0v-65q0-32 17.5-58.5T307-410q32-20 76.5-30t96.5-10q53 0 97.5 10t76.5 30q32 20 49 46.5t17 58.5v65H240Zm540 0v-65q0-26-6.5-49T754-397q11-2 22.5-2.5t23.5-.5q72 0 116 26.5t44 70.5v63H780Zm-455-80h311q-10-20-55.5-35T480-370q-55 0-100.5 15T325-320ZM160-440q-33 0-56.5-23.5T80-520q0-34 23.5-57t56.5-23q34 0 57 23t23 57q0 33-23 56.5T160-440Zm640 0q-33 0-56.5-23.5T720-520q0-34 23.5-57t56.5-23q34 0 57 23t23 57q0 33-23 56.5T800-440Zm-320-40q-50 0-85-35t-35-85q0-51 35-85.5t85-34.5q51 0 85.5 34.5T600-600q0 50-34.5 85T480-480Zm0-80q17 0 28.5-11.5T520-600q0-17-11.5-28.5T480-640q-17 0-28.5 11.5T440-600q0 17 11.5 28.5T480-560Zm1 240Zm-1-280Z"/></svg> User Management</a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/staff-schedules" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm240-240H200v160h240v-160Zm80 0v160h240v-160H520Zm-80-80v-160H200v160h240Zm80 0h240v-160H520v160ZM200-680h560v-80H200v80Z"/></svg> Staff Schedules</a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/temp-workers" class="nav-link">ðŸ”§ Temp Workers</a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/logs" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M480-120q-138 0-240.5-91.5T122-440h82q14 104 92.5 172T480-200q117 0 198.5-81.5T760-480q0-117-81.5-198.5T480-760q-69 0-129 32t-101 88h110v80H120v-240h80v94q51-64 124.5-99T480-840q75 0 140.5 28.5t114 77q48.5 48.5 77 114T840-480q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T480-120Zm112-192L440-464v-216h80v184l128 128-56 56Z"/></svg> Access Logs</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" onclick="logout(); return false;" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z"/></svg> Logout</a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h1>Admin Profile</h1>
                <p>Manage your account settings and face recognition data.</p>
            </div>

            <div class="container-profile">
                <div class="card">
                    <div class="card-header">
                        <h2>Account Overview</h2>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div class="avatar-large">
                                {% if user.photo_path %}
                                <img src="/uploads/{{ user.photo_path.split('/')[-1] }}" alt="Photo">
                                {% else %}
                                {{ user.full_name[0] if user.full_name else '?' }}
                                {% endif %}
                            </div>
                            <div>
                                <h3>{{ user.full_name }}</h3>
                                <p style="color: #64748b;">@{{ user.username }} â€¢ {{ user.email }}</p>
                                <div style="margin-top: 10px;">
                                    {% if user.face_encoding_path %}
                                    <span class="badge badge-success">âœ“ Face Registered</span>
                                    {% else %}
                                    <span class="badge badge-warning">âš  Face Data Required</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Update Information</h2>
                    </div>
                    <div class="card-body">
                        <div id="infoAlertBox"></div>
                        <form id="updateInfoForm">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="fullName" value="{{ user.full_name }}" class="form-control" required>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="email" value="{{ user.email }}" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" id="phone" value="{{ user.phone if user.phone else '' }}" class="form-control">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Face Recognition Data</h2>
                    </div>
                    <div class="card-body">
                        <div id="uploadAlertBox"></div>
                        <form id="uploadForm">
                            <div class="upload-area" id="uploadArea" onclick="document.getElementById('photoInput').click()">
                                <h3>Click to select photo</h3>
                                <p>Ensure good lighting and front-facing view</p>
                            </div>
                            <input type="file" id="photoInput" name="photo" style="display: none;" accept="image/*">
                            <button type="submit" class="btn btn-primary" id="uploadBtn" disabled style="margin-top: 15px; width: 100%;">Upload Photo</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Security</h2>
                    </div>
                    <div class="card-body">
                        <div id="passwordAlertBox"></div>
                        <form id="changePasswordForm">
                            <div class="form-group">
                                <label>Current Password</label>
                                <input type="password" id="currentPassword" class="form-control" required>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label>New Password</label>
                                    <input type="password" id="newPassword" class="form-control" required minlength="8">
                                </div>
                                <div class="form-group">
                                    <label>Confirm New</label>
                                    <input type="password" id="confirmPassword" class="form-control" required minlength="8">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-secondary" style="width: 100%;">Change Password</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Verify session with server
            currentUser = await checkAuth(); 
            
            if (!currentUser || currentUser.role !== 'Admin') {
                window.location.href = '/login';
                return;
            }
            
            // 2. Sync Sidebar UI with verified session data
            document.getElementById('adminNameSidebar').textContent = currentUser.full_name || currentUser.username;
            document.getElementById('adminEmailSidebar').textContent = currentUser.email || 'Administrator';

            // 3. Initialize Photo Preview Logic
            const photoInput = document.getElementById('photoInput');
            const uploadArea = document.getElementById('uploadArea');
            const uploadBtn = document.getElementById('uploadBtn');

            if (photoInput) {
                photoInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            uploadArea.innerHTML = '<img src="' + e.target.result + '" alt="Preview">';
                            uploadArea.classList.add('has-image');
                            uploadBtn.disabled = false;
                        };
                        reader.readAsDataURL(file);
                    }
                };
            }
        });

        // --- HELPER FUNCTION: Show Alert ---
        function showAlert(container, message, type) {
            container.innerHTML = `<div class="alert alert-${type} show">${message}</div>`;
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) alert.classList.remove('show');
            }, 5000);
        }

        // --- FUNCTION 1: Update Personal Information ---
        document.getElementById('updateInfoForm').onsubmit = async (e) => {
            e.preventDefault();
            const infoAlertBox = document.getElementById('infoAlertBox');
            
            const data = {
                full_name: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value
            };

            try {
                const response = await fetch('/admin/profile/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.success) {
                    showAlert(infoAlertBox, 'âœ“ Profile updated successfully!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert(infoAlertBox, 'âœ— ' + (result.message || 'Failed to update'), 'error');
                }
            } catch (err) {
                showAlert(infoAlertBox, 'âœ— Network error. Please try again.', 'error');
            }
        };

        // --- FUNCTION 2: Upload Face Photo ---
        document.getElementById('uploadForm').onsubmit = async (e) => {
            e.preventDefault();
            const uploadAlertBox = document.getElementById('uploadAlertBox');
            const uploadBtn = document.getElementById('uploadBtn');
            const photoInput = document.getElementById('photoInput');

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('photo', photoInput.files[0]);

            try {
                const response = await fetch('/admin/profile/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    showAlert(uploadAlertBox, 'âœ“ Face registered successfully!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert(uploadAlertBox, 'âœ— ' + data.message, 'error');
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Upload Photo';
                }
            } catch (err) {
                showAlert(uploadAlertBox, 'âœ— Network error.', 'error');
                uploadBtn.disabled = false;
            }
        };

        // --- FUNCTION 3: Change Password ---
        document.getElementById('changePasswordForm').onsubmit = async (e) => {
            e.preventDefault();
            const passwordAlertBox = document.getElementById('passwordAlertBox');
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showAlert(passwordAlertBox, 'âœ— New passwords do not match!', 'error');
                return;
            }

            try {
                const response = await fetch('/admin/profile/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
                });
                const result = await response.json();

                if (result.success) {
                    showAlert(passwordAlertBox, 'âœ“ Password updated!', 'success');
                    e.target.reset();
                } else {
                    showAlert(passwordAlertBox, 'âœ— ' + (result.message || 'Error'), 'error');
                }
            } catch (err) {
                showAlert(passwordAlertBox, 'âœ— Network error.', 'error');
            }
        };
        // All other original fetch logic for forms (uploadForm, updateInfoForm, changePasswordForm)
        // should remain exactly as they were in your uploaded file.
    </script>
</body>

</html>
