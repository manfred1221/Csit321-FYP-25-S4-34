<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Profile - Condo Access</title>
    <link rel="stylesheet" href="/frontend/css/styles.css">
    <script src="/frontend/js/config.js"></script>
    <style>
        /* Maintain specific profile card styling within the new layout */
        .container-profile {
            max-width: 800px;
            margin: 0 auto;
        }

        .avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #fff;
            overflow: hidden;
            flex-shrink: 0;
        }

        .avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-area {
            border: 3px dashed #cbd5e1;
            border-radius: 8px;
            padding: 40px 30px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8fafc;
            text-align: center;
        }

        .upload-area:hover {
            border-color: #3b82f6;
            background: #f0f7ff;
        }

        .upload-area.has-image {
            border-style: solid;
            border-color: #10b981;
            background: #ecfdf5;
        }

        .upload-area img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üè¢ Condo Access</h2>
                <div class="user-info">
                    <strong id="adminNameSidebar">Loading...</strong>
                    <p id="adminEmailSidebar">admin@condo.com</p>
                </div>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="/admin/profile" class="nav-link active">üë§ My Profile</a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/users" class="nav-link">üë• User Management</a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/staff-schedules" class="nav-link">üìÖ Staff Schedules</a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/temp-workers" class="nav-link">üîß Temp Workers</a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/logs" class="nav-link">üìã Access Logs</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" onclick="logout(); return false;" class="nav-link">üö™ Logout</a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h1>Admin Profile</h1>
                <p>Manage your account settings and face recognition data.</p>
            </div>

            <div class="container-profile">
                <div class="card">
                    <div class="card-header">
                        <h2>Account Overview</h2>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div class="avatar-large">
                                {% if user.photo_path %}
                                <img src="/uploads/{{ user.photo_path.split('/')[-1] }}" alt="Photo">
                                {% else %}
                                {{ user.full_name[0] if user.full_name else '?' }}
                                {% endif %}
                            </div>
                            <div>
                                <h3>{{ user.full_name }}</h3>
                                <p style="color: #64748b;">@{{ user.username }} ‚Ä¢ {{ user.email }}</p>
                                <div style="margin-top: 10px;">
                                    {% if user.face_encoding_path %}
                                    <span class="badge badge-success">‚úì Face Registered</span>
                                    {% else %}
                                    <span class="badge badge-warning">‚ö† Face Data Required</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Update Information</h2>
                    </div>
                    <div class="card-body">
                        <div id="infoAlertBox"></div>
                        <form id="updateInfoForm">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="fullName" value="{{ user.full_name }}" class="form-control" required>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="email" value="{{ user.email }}" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" id="phone" value="{{ user.phone if user.phone else '' }}" class="form-control">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Face Recognition Data</h2>
                    </div>
                    <div class="card-body">
                        <div id="uploadAlertBox"></div>
                        <form id="uploadForm">
                            <div class="upload-area" id="uploadArea" onclick="document.getElementById('photoInput').click()">
                                <h3>Click to select photo</h3>
                                <p>Ensure good lighting and front-facing view</p>
                            </div>
                            <input type="file" id="photoInput" name="photo" style="display: none;" accept="image/*">
                            <button type="submit" class="btn btn-primary" id="uploadBtn" disabled style="margin-top: 15px; width: 100%;">Upload Photo</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Security</h2>
                    </div>
                    <div class="card-body">
                        <div id="passwordAlertBox"></div>
                        <form id="changePasswordForm">
                            <div class="form-group">
                                <label>Current Password</label>
                                <input type="password" id="currentPassword" class="form-control" required>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label>New Password</label>
                                    <input type="password" id="newPassword" class="form-control" required minlength="8">
                                </div>
                                <div class="form-group">
                                    <label>Confirm New</label>
                                    <input type="password" id="confirmPassword" class="form-control" required minlength="8">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-secondary" style="width: 100%;">Change Password</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Verify session with server
            currentUser = await checkAuth(); 
            
            if (!currentUser || currentUser.role !== 'Admin') {
                window.location.href = '/login';
                return;
            }
            
            // 2. Sync Sidebar UI with verified session data
            document.getElementById('adminNameSidebar').textContent = currentUser.full_name || currentUser.username;
            document.getElementById('adminEmailSidebar').textContent = currentUser.email || 'Administrator';

            // 3. Initialize Photo Preview Logic
            const photoInput = document.getElementById('photoInput');
            const uploadArea = document.getElementById('uploadArea');
            const uploadBtn = document.getElementById('uploadBtn');

            if (photoInput) {
                photoInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            uploadArea.innerHTML = '<img src="' + e.target.result + '" alt="Preview">';
                            uploadArea.classList.add('has-image');
                            uploadBtn.disabled = false;
                        };
                        reader.readAsDataURL(file);
                    }
                };
            }
        });

        // --- HELPER FUNCTION: Show Alert ---
        function showAlert(container, message, type) {
            container.innerHTML = `<div class="alert alert-${type} show">${message}</div>`;
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) alert.classList.remove('show');
            }, 5000);
        }

        // --- FUNCTION 1: Update Personal Information ---
        document.getElementById('updateInfoForm').onsubmit = async (e) => {
            e.preventDefault();
            const infoAlertBox = document.getElementById('infoAlertBox');
            
            const data = {
                full_name: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value
            };

            try {
                const response = await fetch('/admin/profile/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.success) {
                    showAlert(infoAlertBox, '‚úì Profile updated successfully!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert(infoAlertBox, '‚úó ' + (result.message || 'Failed to update'), 'error');
                }
            } catch (err) {
                showAlert(infoAlertBox, '‚úó Network error. Please try again.', 'error');
            }
        };

        // --- FUNCTION 2: Upload Face Photo ---
        document.getElementById('uploadForm').onsubmit = async (e) => {
            e.preventDefault();
            const uploadAlertBox = document.getElementById('uploadAlertBox');
            const uploadBtn = document.getElementById('uploadBtn');
            const photoInput = document.getElementById('photoInput');

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('photo', photoInput.files[0]);

            try {
                const response = await fetch('/admin/profile/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    showAlert(uploadAlertBox, '‚úì Face registered successfully!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert(uploadAlertBox, '‚úó ' + data.message, 'error');
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Upload Photo';
                }
            } catch (err) {
                showAlert(uploadAlertBox, '‚úó Network error.', 'error');
                uploadBtn.disabled = false;
            }
        };

        // --- FUNCTION 3: Change Password ---
        document.getElementById('changePasswordForm').onsubmit = async (e) => {
            e.preventDefault();
            const passwordAlertBox = document.getElementById('passwordAlertBox');
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showAlert(passwordAlertBox, '‚úó New passwords do not match!', 'error');
                return;
            }

            try {
                const response = await fetch('/admin/profile/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
                });
                const result = await response.json();

                if (result.success) {
                    showAlert(passwordAlertBox, '‚úì Password updated!', 'success');
                    e.target.reset();
                } else {
                    showAlert(passwordAlertBox, '‚úó ' + (result.message || 'Error'), 'error');
                }
            } catch (err) {
                showAlert(passwordAlertBox, '‚úó Network error.', 'error');
            }
        };
        // All other original fetch logic for forms (uploadForm, updateInfoForm, changePasswordForm)
        // should remain exactly as they were in your uploaded file.
    </script>
</body>

</html>
