<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Security Officer Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { margin: 5px; padding: 10px; }
        input { margin: 5px; padding: 5px; }
        #log { margin-top: 20px; border: 1px solid #ccc; padding: 10px; max-height: 200px; overflow-y: scroll; }
    </style>
    </head>
    <body>
        <h1>Security Officer Dashboard (Prototype)</h1>

    <h2>Monitor Camera</h2>
    <video id="cameraFeed" width="640" height="480" autoplay></video>
    <button id="startCamera">Start Camera</button>
    <button id="stopCamera">Stop Camera</button>

    <script>
    let stream = null; // store the webcam stream

    const video = document.getElementById("cameraFeed");

    document.getElementById("startCamera").addEventListener("click", async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
        } catch (err) {
            console.error("Error accessing webcam:", err);
        }
    });

    document.getElementById("stopCamera").addEventListener("click", () => {
        if (stream) {
            // Stop all video tracks
            stream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
            stream = null;
        }
    });
    </script>

    <h2>Manual Override</h2>
    <input type="number" id="officerId" placeholder="Officer ID (optional)" />
    <button onclick="manualOverride()">Open Gate</button>

    <script>
    function log(message) {
        const logDiv = document.getElementById("log");
        logDiv.innerHTML += `<p>${message}</p>`;
    }

    function manualOverride() {
        const officerId = document.getElementById("officerId").value;
        const payload = { officer_id: officerId ? parseInt(officerId) : null };

        fetch("http://localhost:5001/api/security_officer/manual_override", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
            .then(res => res.json())
            .then(data => log(JSON.stringify(data)))
            .catch(err => log("Fetch error: " + err));
    }
    </script>

    <h2>View Profile</h2>
    <input type="number" id="officerIdProfile" placeholder="Officer ID" />
    <button onclick="viewProfile()">View Profile</button>

    <h2>Update Profile</h2>
    <input type="text" id="fullName" placeholder="Full Name" />
    <input type="text" id="contactNumber" placeholder="Contact Number" />
    <input type="text" id="shift" placeholder="Shift" />
    <button onclick="updateProfile()">Update Profile</button>

    <h2>Deactivate Account</h2>
    <button onclick="deactivateAccount()">Deactivate Account</button>

    <h2>Face Verification</h2>
    <video id="verifyCamera" width="320" height="240" autoplay></video>
    <button id="startVerifyCamera">Start Camera</button>
    <button id="captureFace">Verify Face</button>

    <script>
    const verifyVideo = document.getElementById("verifyCamera");
    let verifyStream = null;

    // Start webcam for verification
    document.getElementById("startVerifyCamera").addEventListener("click", async () => {
        try {
            verifyStream = await navigator.mediaDevices.getUserMedia({ video: true });
            verifyVideo.srcObject = verifyStream;
            log("Webcam started for face verification.");
        } catch (err) {
            log("Error accessing webcam: " + err);
        }
    });

   // Capture face and send to backend
document.getElementById("captureFace").addEventListener("click", async () => {
    if (!verifyStream) return log("Start the camera first.");

    try {
        const scale = 0.5;
        const canvas = document.createElement("canvas");
        canvas.width = verifyVideo.videoWidth * scale;
        canvas.height = verifyVideo.videoHeight * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(verifyVideo, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL("image/jpeg");

        const officerId = document.getElementById("officerId").value;
        const payload = { image: imageData, officer_id: officerId ? parseInt(officerId) : null };

        const baseUrl = "/api/security_officer";
        const res = await fetch(`${baseUrl}/face_verify`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const text = await res.text();
        let data;
        try {
            data = JSON.parse(text);
        } catch {
            return log("Server returned non-JSON response:\n" + text);
        }

        log("Face Verification Response: " + JSON.stringify(data));

        // --- NEW: show inputs if backend says this is a new officer ---
        if (data.status === "new") {
    const div = document.createElement("div");
    div.id = "newOfficerForm";
    div.innerHTML = `
        <h3>New Officer Registration</h3>
        <input type="text" id="newFullName" placeholder="Full Name" /><br/>
        <input type="text" id="newContactNumber" placeholder="Contact Number" /><br/>
        <input type="text" id="newShift" placeholder="Shift" /><br/>
        <button id="saveNewOfficer">Save Officer</button>
    `;
    document.body.appendChild(div);

    document.getElementById("saveNewOfficer").addEventListener("click", async () => {
        const newPayload = {
            full_name: document.getElementById("newFullName").value,
            contact_number: document.getElementById("newContactNumber").value,
            shift: document.getElementById("newShift").value,
            image: imageData  // send captured image
        };

        const res2 = await fetch(`${baseUrl}/register_officer`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newPayload)
        });

        const result2 = await res2.json();
        log("Officer registered: " + JSON.stringify(result2));
        div.remove();
    });
        }

    } catch (err) {
        log("Fetch error: " + err);
    }
});
    </script>

    <div id="log"></div>

<script>
const baseUrl = "/api/security_officer";

function log(message) {
    const logDiv = document.getElementById("log");
    logDiv.innerHTML += `<p>${message}</p>`;
}

function monitorCamera() {
    fetch(`${baseUrl}/monitor_camera`)
        .then(res => res.json())
        .then(data => log(JSON.stringify(data)))
        .catch(err => log(err));
}

function manualOverride() {
    fetch("http://localhost:5001/api/security_officer/manual_override", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ officer_id: officerId ? parseInt(officerId) : null })
})
.then(async res => {
    const text = await res.text();
    try {
        const data = JSON.parse(text);
        log(JSON.stringify(data));
    } catch {
        log("Server returned non-JSON response:");
        log(text);
    }
})
.catch(err => log("Fetch error: " + err));
}

function viewProfile() {
    const officerId = document.getElementById("officerIdProfile").value;
    if (!officerId) return log("Enter an Officer ID");

    fetch(`${baseUrl}/profile/${officerId}`)
        .then(async res => {
            const text = await res.text();
            try {
                const data = JSON.parse(text);
                log(JSON.stringify(data));
            } catch {
                log("Server returned non-JSON response:");
                log(text);
            }
        })
        .catch(err => log("Fetch error: " + err));
}



function updateProfile() {
    const officerId = document.getElementById("officerId").value;
    const payload = {
        full_name: document.getElementById("fullName").value,
        contact_number: document.getElementById("contactNumber").value,
        shift: document.getElementById("shift").value
    };
    fetch(`${baseUrl}/profile/${officerId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
        .then(res => res.json())
        .then(data => log(JSON.stringify(data)))
        .catch(err => log(err));
}

function deactivateAccount() {
    const officerId = document.getElementById("officerId").value;
    fetch(`${baseUrl}/deactivate_account/${officerId}`, { method: "POST" })
        .then(res => res.json())
        .then(data => log(JSON.stringify(data)))
        .catch(err => log(err));
}

function faceVerify() {
    const officerId = document.getElementById("officerId").value;
    let embedding = document.getElementById("embedding").value;
    try {
        embedding = JSON.parse(embedding);
    } catch {
        log("Invalid embedding JSON");
        return;
    }
    const payload = { officer_id: parseInt(officerId), embedding: embedding };
    fetch(`${baseUrl}/face_verify`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
        .then(res => res.json())
        .then(data => log(JSON.stringify(data)))
        .catch(err => log(err));
}
</script>
</body>
</html>
