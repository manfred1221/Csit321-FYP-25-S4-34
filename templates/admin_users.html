<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Condo Access</title>
    <link rel="stylesheet" href="/frontend/css/styles.css">
    <style>
        .bulk-actions {
            background: #fff1f2; border: 1px solid #fecdd3; color: #be123c;
            padding: 8px 15px; border-radius: 6px; font-size: 14px;
            display: none; align-items: center;
        }
        .badge { min-width: 60px; display: inline-block; text-align: center; text-transform: capitalize; }
    </style>
</head>
<body>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ¢ Condo Access</h2>
                <div class="user-info"><strong id="adminNameSidebar">Loading...</strong></div>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="/admin/profile" class="nav-link">ğŸ‘¤ My Profile</a></li>
                    <li class="nav-item"><a href="/admin/users" class="nav-link active">ğŸ‘¥ User Management</a></li>
                    <li class="nav-item"><a href="/admin/staff-schedules" class="nav-link">ğŸ“… Staff Schedules</a></li>
                    <li class="nav-item"><a href="/admin/temp-workers" class="nav-link">ğŸ”§ Temp Workers</a></li>
                    <li class="nav-item"><a href="/admin/logs" class="nav-link">ğŸ“‹ Access Logs</a></li>
                    <li class="nav-item"><a href="#" onclick="logout(); return false;" class="nav-link">ğŸšª Logout</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div><h1>User Management</h1><p>Manage residents, staff, and system administrators.</p></div>
                <a href="/admin/users/create" class="btn btn-primary">+ Add New User</a>
            </div>

            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Registered Users</h2>
                    <div class="bulk-actions" id="bulkActions">
                        <span id="selectedCount" style="margin-right: 10px; font-weight:600;">0 selected</span>
                        <button class="btn btn-sm btn-danger" onclick="bulkDelete()">Delete Selected</button>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Unit / Details</th>
                                    <th>Status</th>
                                    <th>Face</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td><input type="checkbox" class="user-checkbox" value="{{ user.id }}" onchange="updateBulkActions()"></td>
                                    <td><strong>{{ user.full_name or user.username }}</strong><br><small style="color: #64748b;">{{ user.email }}</small></td>
                                    <td><span class="badge badge-info">{{ user.role }}</span></td>
                                    <td>{{ user.unit_number or '-' }}</td>
                                    <td>
                                        <span class="badge {{ 'badge-success' if user.status == 'active' else 'badge-danger' }}">
                                            {{ user.status }}
                                        </span>
                                    </td>
                                    <td>{{ 'âœ…' if user.face_encoding_path else 'âŒ' }}</td>
                                    <td>
                                        <div style="display: flex; gap: 5px;">
                                            <a href="/admin/users/{{ user.id }}/edit" class="btn btn-sm btn-secondary">Edit</a>
                                            <button class="btn btn-sm btn-danger" onclick="deleteUser({{ user.id }})">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="7" style="text-align: center; padding: 30px; color: #64748b;">No users found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/frontend/js/config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const currentUser = await checkAuth(); 
            if (!currentUser || currentUser.role !== 'Admin') { window.location.href = '/login'; return; }
            document.getElementById('adminNameSidebar').textContent = currentUser.full_name || currentUser.username;
        });

        async function deleteUser(id) {
            if (!confirm('Delete this user?')) return;
            const res = await fetch('/admin/users/' + id, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) location.reload();
            else alert(data.message || 'Delete failed');
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateBulkActions();
        }

        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            const bulk = document.getElementById('bulkActions');
            if (checkboxes.length > 0) {
                bulk.style.display = 'flex';
                document.getElementById('selectedCount').textContent = checkboxes.length + ' selected';
            } else {
                bulk.style.display = 'none';
            }
        }

        async function bulkDelete() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);
            if (ids.length === 0) return;
            if (!confirm(`Delete ${ids.length} users?`)) return;
            let count = 0;
            for (const id of ids) {
                try {
                    const res = await fetch('/admin/users/' + id, { method: 'DELETE' });
                    const d = await res.json();
                    if (d.success) count++;
                } catch(e) {}
            }
            alert(`Deleted ${count} users.`);
            location.reload();
        }
    </script>
</body>
</html>