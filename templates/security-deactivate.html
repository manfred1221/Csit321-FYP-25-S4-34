<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deactivate Account - Security</title>
    <link rel="stylesheet" href="/frontend/css/styles.css">
    <script src="/frontend/js/config.js"></script>
</head>
<body>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üîê Condo Access</h2>
                <div class="user-info"><div>{{officer.full_name}}</div><div>{{officer.contact_number}}</div></div>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="/security-dashboard" class="nav-link">üìπ Monitor Cameras</a></li>
                    <li class="nav-item"><a href="/security-override" class="nav-link">üö™ Manual Override</a></li>
                    <li class="nav-item"><a href="/security-view-profile" class="nav-link">üë§ View Profile</a></li>
                    <li class="nav-item"><a href="/security-update-profile" class="nav-link">‚úèÔ∏è Update Profile</a></li>
                    <li class="nav-item"><a href="/security-deactivate" class="nav-link active">‚ö†Ô∏è Deactivate Account</a></li>
                    <li class="nav-item"><a href="/security-face-verification" class="nav-link">üîç Face Verification</a></li>
                    <li class="nav-item"><a href="#" onclick="logout(); return false;" class="nav-link">üö™ Logout</a></li>
                </ul>
            </nav>
        </aside>
        <main class="main-content">
            <div class="page-header"><h1>Deactivate Account</h1><p>Permanently deactivate your security officer account</p></div>
            <div class="alert alert-warning" style="margin-bottom:20px;">
                <strong>‚ö†Ô∏è Warning: This action cannot be undone</strong><br>
                Deactivating your account will permanently remove your access to the system. All your data, shift history, and credentials will be archived but you will no longer be able to log in.
            </div>
            <div class="card">
                <div class="card-header"><h2>‚ùå Account Deactivation</h2></div>
                <div class="card-body">
                    <div style="background:#fee2e2;border-left:4px solid #ef4444;padding:20px;border-radius:8px;margin-bottom:20px;">
                        <h3 style="margin:0 0 10px 0;color:#991b1b;">Before You Proceed</h3>
                        <ul style="margin:0;padding-left:20px;color:#991b1b;">
                            <li>You will lose access to all security monitoring systems</li>
                            <li>Your shift schedule will be removed</li>
                            <li>Manual override privileges will be revoked</li>
                            <li>All active sessions will be terminated</li>
                            <li>This action requires supervisor approval</li>
                        </ul>
                    </div>
                    <form id="deactivateForm">
                        <div class="form-group">
                            <label>Reason for Deactivation</label>
                            <select id="reason" class="form-control">
                                <option value="">Select a reason...</option>
                                <option>Resignation</option>
                                <option>Retirement</option>
                                <option>Transfer to Another Property</option>
                                <option>Contract Ended</option>
                                <option>Personal Reasons</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Additional Comments (Optional)</label>
                            <textarea id="comments" rows="4" placeholder="Please provide any additional details..." class="form-control"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Confirm Your Password</label>
                            <input type="password" id="password" placeholder="Enter your password to confirm" class="form-control">
                        </div>
                        <div class="form-group">
                            <label style="display:flex;align-items:center;gap:10px;">
                                <input type="checkbox" id="confirmCheck">
                                <span>I understand that this action is permanent and cannot be reversed</span>
                            </label>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button type="button" class="btn btn-danger" onclick="deactivateAccount()" style="flex:1;">‚ö†Ô∏è Deactivate Account</button>
                            <a href="security-dashboard.html" class="btn btn-secondary" style="flex:1;text-align:center;">Cancel</a>
                        </div>
                    </form>
                    <div id="message" class="message"></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h2>üí¨ Need Help?</h2></div>
                <div class="card-body">
                    <p>If you're experiencing issues or have concerns, please contact your supervisor before deactivating your account.</p>
                    <p><strong>Supervisor Contact:</strong> supervisor@security.com | +65 9000 1234</p>
                    <p><strong>HR Department:</strong> hr@property.com | +65 6123 4567</p>
                </div>
            </div>
        </main>
    </div>
    <script>
        // Load config first
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Verify session with server
            currentUser = await checkAuth(); 
            
            if (!currentUser) return; // config.js handles redirect to /login

            // 2. Role Authorization (Match the role set in app.py)
            if (currentUser.role !== 'security_officer' && currentUser.role !== 'Security') {
                window.location.href = '/login';
                return;
            }

            // 3. Update Sidebar UI with real session data
            document.getElementById('officerName').textContent = currentUser.full_name || currentUser.username;
            document.getElementById('officerEmail').textContent = currentUser.email || currentUser.contact_number;
        });

        async function deactivateAccount() {
            const reason = document.getElementById('reason').value;
            const comments = document.getElementById('comments').value;
            const password = document.getElementById('password').value;
            const confirmed = document.getElementById('confirmCheck').checked;

            // Validation
            if (!reason) {
                showMsg('Please select a reason for deactivation', 'error');
                return;
            }
            if (!password) {
                showMsg('Please enter your password to confirm', 'error');
                return;
            }
            if (!confirmed) {
                showMsg('Please confirm that you understand this action is permanent', 'error');
                return;
            }

            if (!confirm('Are you absolutely sure you want to deactivate your account? This cannot be undone.')) {
                return;
            }

            try {
                // Call your backend API
                const res = await fetch(`/api/security_officer/deactivate_account/${currentUser.officer_id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        password, 
                        reason,
                        comments 
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    showMsg(data.message, 'success');
                } else {
                    showMsg(data.error || 'Failed to deactivate account', 'error');
                }

            } catch (err) {
                console.error(err);
                showMsg('Server error during deactivation', 'error');
            }
        }

        // Reuse your existing message display
        function showMsg(msg, type) {
            const el = document.getElementById('message');
            el.textContent = msg;
            el.className = 'message ' + type;
            el.style.display = 'block';
        }
    </script>
</body>
</html>
