<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deactivate Account - Security</title>
    <link rel="stylesheet" href="/frontend/css/styles.css">
    <script src="/frontend/js/config.js"></script>
</head>
<body>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M120-120v-560h160v-160h400v320h160v400H520v-160h-80v160H120Zm80-80h80v-80h-80v80Zm0-160h80v-80h-80v80Zm0-160h80v-80h-80v80Zm160 160h80v-80h-80v80Zm0-160h80v-80h-80v80Zm0-160h80v-80h-80v80Zm160 320h80v-80h-80v80Zm0-160h80v-80h-80v80Zm0-160h80v-80h-80v80Zm160 480h80v-80h-80v80Zm0-160h80v-80h-80v80Z"/></svg> Condo Access</h2>
                <div class="user-info"><div>{{officer.full_name}}</div><div>{{officer.contact_number}}</div></div>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="/security-dashboard" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M200-320h400L462-500l-92 120-62-80-108 140Zm-40 160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h480q33 0 56.5 23.5T720-720v180l160-160v440L720-420v180q0 33-23.5 56.5T640-160H160Zm0-80h480v-480H160v480Zm0 0v-480 480Z"/></svg> Monitor Cameras</a></li>
                    <li class="nav-item"><a href="/security-override" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M440-440q17 0 28.5-11.5T480-480q0-17-11.5-28.5T440-520q-17 0-28.5 11.5T400-480q0 17 11.5 28.5T440-440ZM280-120v-80l240-40v-445q0-15-9-27t-23-14l-208-34v-80l220 36q44 8 72 41t28 77v512l-320 54Zm-160 0v-80h80v-560q0-34 23.5-57t56.5-23h400q34 0 57 23t23 57v560h80v80H120Zm160-80h400v-560H280v560Z"/></svg> Manual Override</a></li>
                    <li class="nav-item"><a href="/security-view-profile" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M234-276q51-39 114-61.5T480-360q69 0 132 22.5T726-276q35-41 54.5-93T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 59 19.5 111t54.5 93Zm246-164q-59 0-99.5-40.5T340-580q0-59 40.5-99.5T480-720q59 0 99.5 40.5T620-580q0 59-40.5 99.5T480-440Zm0 360q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q53 0 100-15.5t86-44.5q-39-29-86-44.5T480-280q-53 0-100 15.5T294-220q39 29 86 44.5T480-160Zm0-360q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm0-60Zm0 360Z"/></svg> View Profile</a></li>
                    <li class="nav-item"><a href="/security-update-profile" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/></svg> Update Profile</a></li>
                    <li class="nav-item"><a href="/security-deactivate" class="nav-link active"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M791-55 686-160H160v-112q0-34 17.5-62.5T224-378q45-23 91.5-37t94.5-21L55-791l57-57 736 736-57 57ZM240-240h366L486-360h-6q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32Zm496-138q29 14 46 42.5t18 61.5L666-408q18 7 35.5 14t34.5 16ZM568-506l-59-59q23-9 37-29.5t14-45.5q0-33-23.5-56.5T480-720q-25 0-45.5 14T405-669l-59-59q23-34 58-53t76-19q66 0 113 47t47 113q0 41-19 76t-53 58Zm38 266H240h366ZM457-617Z"/></svg> Deactivate Account</a></li>
                    <li class="nav-item"><a href="/security-face-verification" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M120-160v-112q0-34 17.5-62.5T184-378q62-31 126-46.5T440-440q20 0 40 1.5t40 4.5q-4 58 21 109.5t73 84.5v80H120ZM760-40l-60-60v-186q-44-13-72-49.5T600-420q0-58 41-99t99-41q58 0 99 41t41 99q0 45-25.5 80T790-290l50 50-60 60 60 60-80 80ZM440-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47Zm300 80q17 0 28.5-11.5T780-440q0-17-11.5-28.5T740-480q-17 0-28.5 11.5T700-440q0 17 11.5 28.5T740-400Z"/></svg> Face Verification</a></li>
                    <li class="nav-item"><a href="#" onclick="logout(); return false;" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z"/></svg> Logout</a></li>
                </ul>
            </nav>
        </aside>
        <main class="main-content">
            <div class="page-header"><h1>Deactivate Account</h1><p>Permanently deactivate your security officer account</p></div>
            <div class="alert alert-warning" style="margin-bottom:20px;">
                <strong>‚ö†Ô∏è Warning: This action cannot be undone</strong><br>
                Deactivating your account will permanently remove your access to the system. All your data, shift history, and credentials will be archived but you will no longer be able to log in.
            </div>
            <div class="card">
                <div class="card-header"><h2>‚ùå Account Deactivation</h2></div>
                <div class="card-body">
                    <div style="background:#fee2e2;border-left:4px solid #ef4444;padding:20px;border-radius:8px;margin-bottom:20px;">
                        <h3 style="margin:0 0 10px 0;color:#991b1b;">Before You Proceed</h3>
                        <ul style="margin:0;padding-left:20px;color:#991b1b;">
                            <li>You will lose access to all security monitoring systems</li>
                            <li>Your shift schedule will be removed</li>
                            <li>Manual override privileges will be revoked</li>
                            <li>All active sessions will be terminated</li>
                            <li>This action requires supervisor approval</li>
                        </ul>
                    </div>
                    <form id="deactivateForm">
                        <div class="form-group">
                            <label>Reason for Deactivation</label>
                            <select id="reason" class="form-control">
                                <option value="">Select a reason...</option>
                                <option>Resignation</option>
                                <option>Retirement</option>
                                <option>Transfer to Another Property</option>
                                <option>Contract Ended</option>
                                <option>Personal Reasons</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Additional Comments (Optional)</label>
                            <textarea id="comments" rows="4" placeholder="Please provide any additional details..." class="form-control"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Confirm Your Password</label>
                            <input type="password" id="password" placeholder="Enter your password to confirm" class="form-control">
                        </div>
                        <div class="form-group">
                            <label style="display:flex;align-items:center;gap:10px;">
                                <input type="checkbox" id="confirmCheck">
                                <span>I understand that this action is permanent and cannot be reversed</span>
                            </label>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button type="button" class="btn btn-danger" onclick="deactivateAccount()" style="flex:1;">‚ö†Ô∏è Deactivate Account</button>
                            <a href="security-dashboard.html" class="btn btn-secondary" style="flex:1;text-align:center;">Cancel</a>
                        </div>
                    </form>
                    <div id="message" class="message"></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h2>üí¨ Need Help?</h2></div>
                <div class="card-body">
                    <p>If you're experiencing issues or have concerns, please contact your supervisor before deactivating your account.</p>
                    <p><strong>Supervisor Contact:</strong> supervisor@security.com | +65 9000 1234</p>
                    <p><strong>HR Department:</strong> hr@property.com | +65 6123 4567</p>
                </div>
            </div>
        </main>
    </div>
    <script>
        // Load config first
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Verify session with server
            currentUser = await checkAuth(); 
            
            if (!currentUser) return; // config.js handles redirect to /login

            // 2. Role Authorization (Match the role set in app.py)
            if (currentUser.role !== 'security_officer' && currentUser.role !== 'Security') {
                window.location.href = '/login';
                return;
            }

            // 3. Update Sidebar UI with real session data
            document.getElementById('officerName').textContent = currentUser.full_name || currentUser.username;
            document.getElementById('officerEmail').textContent = currentUser.email || currentUser.contact_number;
        });

        async function deactivateAccount() {
            const reason = document.getElementById('reason').value;
            const comments = document.getElementById('comments').value;
            const password = document.getElementById('password').value;
            const confirmed = document.getElementById('confirmCheck').checked;

            // Validation
            if (!reason) {
                showMsg('Please select a reason for deactivation', 'error');
                return;
            }
            if (!password) {
                showMsg('Please enter your password to confirm', 'error');
                return;
            }
            if (!confirmed) {
                showMsg('Please confirm that you understand this action is permanent', 'error');
                return;
            }

            if (!confirm('Are you absolutely sure you want to deactivate your account? This cannot be undone.')) {
                return;
            }

            try {
                // Call your backend API
                const res = await fetch(`/api/security_officer/deactivate_account/${currentUser.officer_id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        password, 
                        reason,
                        comments 
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    showMsg(data.message, 'success');
                } else {
                    showMsg(data.error || 'Failed to deactivate account', 'error');
                }

            } catch (err) {
                console.error(err);
                showMsg('Server error during deactivation', 'error');
            }
        }

        // Reuse your existing message display
        function showMsg(msg, type) {
            const el = document.getElementById('message');
            el.textContent = msg;
            el.className = 'message ' + type;
            el.style.display = 'block';
        }
    </script>
</body>
</html>
